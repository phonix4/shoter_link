<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shorter Link - Visitor Location Tracker</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+eJxQ00oUnYowsZDer6XsRmXrxJRPeelROjv9lunw=" crossorigin=""/>
<style>
  /* Reset and base */
  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin:0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #6b21a8 0%, #0ea5e9 100%);
    color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: rgba(31, 41, 55, 0.85);
    backdrop-filter: saturate(180%) blur(20px);
    padding: 20px 40px;
    text-align: center;
    font-size: 1.8rem;
    font-weight: 900;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    user-select: none;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.3);
    color: #d8b4fe;
  }
  main {
    flex: 1;
    max-width: 900px;
    margin: 2rem auto 3rem;
    background: rgba(31, 41, 55, 0.9);
    border-radius: 20px;
    padding: 30px 35px 40px;
    box-shadow: 0 10px 30px rgb(139 92 246 / 0.3);
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
  form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }
  input[type="text"] {
    flex: 1 1 300px;
    padding: 12px 20px;
    font-size: 1.2rem;
    border-radius: 16px;
    border: none;
    background: rgba(255 255 255 / 0.08);
    color: white;
    box-shadow: inset 0 0 14px rgb(111 66 193 / 0.7);
    transition: background-color 0.3s ease;
  }
  input[type="text"]::placeholder {
    color: rgba(255 255 255 / 0.6);
  }
  input[type="text"]:focus {
    outline: none;
    background: rgba(255 255 255 / 0.15);
    box-shadow: 0 0 16px #8b5cf6, inset 0 0 14px rgb(139 92 246 / 0.9);
  }
  button {
    font-weight: 800;
    font-size: 1.1rem;
    padding: 12px 28px;
    border-radius: 16px;
    border: none;
    background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
    color: #fff;
    cursor: pointer;
    box-shadow: 0 8px 24px rgb(6 182 212 / 0.6);
    transition: background-color 0.3s ease, transform 0.3s ease;
    user-select: none;
  }
  button:hover, button:focus {
    background: linear-gradient(135deg, #7c3aed, #0d9488);
    transform: translateY(-3px);
  }
  button:disabled {
    background: rgba(139, 92, 246, 0.3);
    cursor: default;
  }
  #errorMsg {
    color: #f87171;
    font-weight: 600;
    text-align: center;
    margin-top: 4px;
  }
  #results {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
  }
  #visits-list {
    flex: 1 1 300px;
    background: rgba(139, 92, 246, 0.15);
    border-radius: 16px;
    overflow-y: auto;
    max-height: 480px;
    padding: 16px 20px;
    box-shadow: inset 0 0 20px rgb(139 92 246 / 0.4);
  }
  #visits-list h3 {
    margin: 0 0 12px;
    font-weight: 800;
    font-size: 1.4rem;
    color: #e0d7ff;
    letter-spacing: 0.05em;
    user-select: none;
  }
  #visits-list .visit-item {
    background: rgba(255 255 255 / 0.1);
    margin-bottom: 14px;
    border-radius: 12px;
    padding: 14px 16px;
    cursor: pointer;
    transition: background-color 0.25s ease;
    user-select: text;
  }
  #visits-list .visit-item:hover,
  #visits-list .visit-item.active {
    background: rgba(255 255 255 / 0.25);
  }
  #visits-list .visit-item:last-child {
    margin-bottom: 0;
  }
  #visit-info {
    font-size: 1rem;
    margin-bottom: 6px;
    font-weight: 600;
  }
  #visit-location {
    font-size: 0.9rem;
    color: #d8b4fe;
  }
  #map-container {
    flex: 1 1 500px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgb(111 66 193 / 0.7);
  }
  #map {
    width: 100%;
    height: 480px;
    border-radius: 20px;
  }
  footer {
    text-align: center;
    font-size: 0.9rem;
    color: rgba(255 255 255 / 0.5);
    padding: 12px 8px;
    user-select: none;
  }
  /* Scrollbar style */
  #visits-list::-webkit-scrollbar {
    width: 8px;
  }
  #visits-list::-webkit-scrollbar-track {
    background: rgba(0,0,0,0);
  }
  #visits-list::-webkit-scrollbar-thumb {
    background: rgba(139,92,246,0.6);
    border-radius: 6px;
  }
  /* Responsive */
  @media (max-width: 768px) {
    main {
      margin: 1.5rem auto 2rem;
      padding: 20px 25px;
    }
    #results {
      flex-direction: column;
    }
    #map-container, #visits-list {
      max-height: 300px;
      height: 300px;
    }
    #map {
      height: 100%;
    }
  }
</style>
</head>
<body>
<header>Shorter Link</header>
<main>
  <form id="shorten-form" aria-label="Shorter Link Search Form" autocomplete="off" novalidate>
    <input type="text" id="short-input" name="short-input" placeholder="Enter short code or full short link URL (e.g., ?s=abc123)" aria-describedby="form-desc" required />
    <button type="submit" aria-label="Search shorter link visits">Search</button>
    <div id="errorMsg" role="alert" aria-live="assertive" style="display:none;"></div>
  </form>

  <section id="results" aria-live="polite" aria-atomic="true" style="display:none;">
    <div id="visits-list" aria-label="List of visits"></div>
    <div id="map-container">
      <div id="map" aria-label="Map showing visitor location"></div>
    </div>
  </section>
</main>
<footer>Â© 2024 Shorter Link</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6fmr+k/Mcmx3NMA8XNrPfQcKsYpf3V4PPVen2I="
  crossorigin=""></script>
<script>
  // Data structure: stored as array of { shortId, targetUrl, visits: [{ timestamp, ipInfo }] }
  const storageKey = 'shorterLinkAppData_v1';

  // DOM elements
  const form = document.getElementById('shorten-form');
  const shortInput = document.getElementById('short-input');
  const errorMsg = document.getElementById('errorMsg');
  const resultsSection = document.getElementById('results');
  const visitsList = document.getElementById('visits-list');
  const mapContainer = document.getElementById('map-container');

  // Leaflet map and marker global
  let map = null;
  let marker = null;
  let currentActiveVisit = null;

  // Load stored data
  function loadData() {
    const raw = localStorage.getItem(storageKey);
    try {
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  // Save data
  function saveData(data) {
    localStorage.setItem(storageKey, JSON.stringify(data));
  }

  // Format datetime nicely
  function formatDateTime(ts) {
    return new Date(ts).toLocaleString();
  }

  // Get link object by shortId
  function getLink(shortId) {
    return loadData().find(d => d.shortId === shortId);
  }

  // Update visits list UI
  function renderVisits(link) {
    visitsList.innerHTML = '';
    if (!link || !link.visits || link.visits.length === 0) {
      visitsList.textContent = 'No visit data found for this short link.';
      clearMap();
      return;
    }
    link.visits.forEach((visit, idx) => {
      const item = document.createElement('div');
      item.className = 'visit-item';
      item.tabIndex = 0;
      if (idx === 0) item.classList.add('active');
      item.textContent = `${formatDateTime(visit.timestamp)} | IP: ${visit.ipInfo?.ip || 'N/A'} | Location: ${visit.ipInfo?.city || 'Unknown'}, ${visit.ipInfo?.region || ''} ${visit.ipInfo?.country_name || ''}`;
      item.onclick = () => selectVisit(item, visit);
      item.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectVisit(item, visit);
        }
      };
      visitsList.appendChild(item);
      if (idx === 0) updateMap(visit);
    });
  }

  // Initialize map viewer or reset to given location
  function initMap(lat, lon, label) {
    if (!map) {
      map = L.map('map', { scrollWheelZoom: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }
    map.setView([lat, lon], 10);
    if (marker) {
      marker.setLatLng([lat, lon]).setPopupContent(label);
    } else {
      marker = L.marker([lat, lon]).addTo(map).bindPopup(label).openPopup();
    }
    map.invalidateSize();
  }

  // Update map with visit location or show no data
  function updateMap(visit) {
    if (!visit.ipInfo || typeof visit.ipInfo.latitude !== 'number' || typeof visit.ipInfo.longitude !== 'number') {
      clearMap('Location data not available');
      return;
    }
    const label = `${visit.ipInfo.city || 'Unknown city'}, ${visit.ipInfo.region || ''} ${visit.ipInfo.country_name || ''}`;
    initMap(visit.ipInfo.latitude, visit.ipInfo.longitude, label);
  }

  // Clear map marker or show empty
  function clearMap(message) {
    if (marker) {
      map.removeLayer(marker);
      marker = null;
    }
    if (map) {
      map.setView([20,0], 2);
    }
    if (message) {
      visitsList.insertAdjacentHTML('afterend', `<div style="padding:1rem; text-align:center; color:#d8b4fe; font-style: italic;">${message}</div>`);
    }
  }

  // Handle visit selection
  function selectVisit(item, visit) {
    if (currentActiveVisit) currentActiveVisit.classList.remove('active');
    item.classList.add('active');
    currentActiveVisit = item;
    updateMap(visit);
  }

  // URL param short link redirect & logging
  async function handleShortLinkRedirect() {
    const params = new URLSearchParams(window.location.search);
    const shortId = params.get('s');
    if(!shortId) return false;
    const link = getLink(shortId);
    if (!link) {
      document.body.innerHTML = `
      <main style="font-family: 'Poppins', sans-serif; color: #f87171; text-align:center; padding: 3rem 1rem;">
        <h1>Short Link Not Found</h1>
        <p>The short link you followed does not exist.</p>
      </main>`;
      return true;
    }
    const ipInfo = await fetchIpInfo();
    addVisit(shortId, ipInfo);
    window.location.href = link.targetUrl;
    return true;
  }

  // Fetch IP-based location from ipapi.co
  async function fetchIpInfo() {
    try {
      const res = await fetch('https://ipapi.co/json');
      if(!res.ok) throw new Error('Failed to fetch IP info');
      return await res.json();
    } catch {
      return null;
    }
  }

  // Add visit record and save
  function addVisit(shortId, ipInfo) {
    const data = loadData();
    const link = data.find(d => d.shortId === shortId);
    if (!link) return;
    link.visits = link.visits || [];
    link.visits.unshift({ timestamp: Date.now(), ipInfo });
    saveData(data);
  }

  // Short ID generator
  function generateShortId() {
    return Math.random().toString(36).slice(2, 10);
  }

  // Create short link record or return existing
  function createShortLink(url) {
    const data = loadData();
    const found = data.find(d => d.targetUrl === url);
    if (found) return found.shortId;
    const newShortId = generateShortId();
    data.push({ shortId: newShortId, targetUrl: url, visits: [] });
    saveData(data);
    return newShortId;
  }

  // Form submission handler
  function handleFormSubmit(e) {
    e.preventDefault();
    errorMsg.style.display = 'none';

    let val = shortInput.value.trim();

    if(!val) {
      showError('Please enter a valid URL or short link.');
      return;
    }

    // Parse full short link or pure short id
    let shortId = '';
    try {
      const url = new URL(val, window.location.origin);
      if(url.searchParams.has('s')) {
        shortId = url.searchParams.get('s');
      } else {
        // The input might be a raw URL (target URL)
        shortId = null;
      }
    } catch {
      // Not a full URL, treat as raw short id or invalid url
      if(val.match(/^[a-zA-Z0-9]{6,10}$/)) {
        shortId = val;
      } else {
        shortId = null;
      }
    }

    if(shortId) {
      // Lookup and show visits and map for this shortId
      const link = getLink(shortId);
      if (!link) {
        showError('Short link not found.');
        return;
      }
      displayResult(link);
      return;
    }

    // Otherwise treat val as URL to shorten
    if (!/^https?:\/\/.+/.test(val)) {
      showError('Please enter a valid URL starting with http:// or https://');
      return;
    }
    try {
      new URL(val);
    } catch {
      showError('Invalid URL format.');
      return;
    }

    const newShortId = createShortLink(val);
    const shortUrl = `${window.location.origin}${window.location.pathname}?s=${encodeURIComponent(newShortId)}`;

    const createdMsg = `
      <div style="margin-bottom: 1rem;">
        Short link created:&nbsp;
        <a href="${shortUrl}" target="_blank" rel="noopener" style="color:#06b6d4; font-weight:700;">${shortUrl}</a>
      </div>`;
    
    shortInput.value = '';
    showInfo(createdMsg);

    displayResult(getLink(newShortId));
  }

  // Display error message
  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.style.display = 'block';
  }

  // Display informational message
  function showInfo(msg) {
    errorMsg.style.display = 'none';
    if(!infoDiv) {
      infoDiv = document.createElement('div');
      infoDiv.style.marginTop = '1rem';
      infoDiv.style.color = '#9ca3af';
      form.appendChild(infoDiv);
    }
    infoDiv.innerHTML = msg;
  }

  // Display visits and map for selected link
  function displayResult(link) {
    resultsSection.style.display = 'flex';
    renderVisits(link);
  }

  // Render visits list UI
  function renderVisits(link) {
    visitsList.innerHTML = '';
    if (!link.visits || link.visits.length === 0) {
      visitsList.textContent = 'No visits recorded yet for this link.';
      clearMap();
      return;
    }

    link.visits.forEach((visit, idx) => {
      const div = document.createElement('div');
      div.className = 'visit-item';
      div.tabIndex = 0;
      if(idx === 0) div.classList.add('active');

      const ip = visit.ipInfo?.ip ?? 'N/A';
      const city = visit.ipInfo?.city ?? 'Unknown city';
      const region = visit.ipInfo?.region ?? 'Unknown region';
      const country = visit.ipInfo?.country_name ?? 'Unknown country';

      div.textContent = `${formatDateTime(visit.timestamp)} | IP: ${ip} | ${city}, ${region}, ${country}`;
      div.onclick = () => selectVisit(div, visit);
      div.onkeydown = (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectVisit(div, visit);
        }
      };
      visitsList.appendChild(div);

      if(idx === 0) updateMap(visit);
    });
  }

  // Select visit from list
  function selectVisit(element, visit) {
    const prevActive = document.querySelector('#visits-list .visit-item.active');
    if(prevActive) prevActive.classList.remove('active');
    element.classList.add('active');
    updateMap(visit);
  }

  // Initialize or update Leaflet map
  function updateMap(visit) {
    if (!visit.ipInfo || !visit.ipInfo.latitude || !visit.ipInfo.longitude) {
      clearMap('Location data unavailable for this visit.');
      return;
    }
    const lat = visit.ipInfo.latitude;
    const lon = visit.ipInfo.longitude;
    const label = `${visit.ipInfo.city ?? 'Unknown city'}, ${visit.ipInfo.region ?? ''} ${visit.ipInfo.country_name ?? ''}`;
    if(!map) {
      map = L.map('map', {
        center: [lat, lon],
        zoom: 10,
        scrollWheelZoom: false,
        keyboard: true,
        tap: false
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      marker = L.marker([lat, lon]).addTo(map).bindPopup(label).openPopup();
    } else {
      map.setView([lat, lon], 10);
      if(marker) marker.setLatLng([lat, lon]).setPopupContent(label).openPopup();
      else marker = L.marker([lat, lon]).addTo(map).bindPopup(label).openPopup();
      map.invalidateSize();
    }
  }
  // Clear map or show default message
  function clearMap(msg) {
    if(marker) {
      map.removeLayer(marker);
      marker = null;
    }
    if(map) {
      map.setView([20,0], 2);
    }
    visitsList.insertAdjacentHTML('afterend', `<div style="padding:1rem; text-align:center; color:#d8b4fe; font-style: italic;">${msg}</div>`);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // If short param present, instantly redirect but log visit
    const params = new URLSearchParams(window.location.search);
    const shortId = params.get('s');
    if(shortId) {
      const data = loadData();
      const link = data.find(d => d.shortId === shortId);
      if(!link) {
        document.body.innerHTML = `<main style="font-family:Poppins,sans-serif; text-align:center; color:#f87171; padding:3rem 1rem;">
        <h1>Short Link Not Found</h1><p>No matching short link in database.</p></main>`;
        return;
      }
      const ipInfo = await fetchIpInfo();
      addVisit(shortId, ipInfo);
      // Redirect after short delay to allow logging
      setTimeout(() => {
        window.location.href = link.targetUrl;
      }, 700);
      document.body.innerHTML = `<main style="font-family:Poppins,sans-serif; text-align:center; padding:5rem 1rem; color:#fff;">
      <h1 style="margin-bottom:1rem;">Redirecting...</h1>
      <p style="opacity:0.8;">You will be redirected shortly to the destination.</p>
      </main>`;
      return;
    }

    // Normal UI for shortening & viewing visits
    form.addEventListener('submit', handleFormSubmit);
  });

  // Fetch visitor IP/location info
  async function fetchIpInfo() {
    try {
      const res = await fetch('https://ipapi.co/json');
      if(!res.ok) throw new Error('IP info fetch failed');
      return await res.json();
    } catch {
      return null;
    }
  }

</script>
</body>
</html>
